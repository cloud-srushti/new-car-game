/*
Single-file Node.js server that serves the 3D car game HTML and provides
endpoints to save and list player scores in a MySQL database.

How to use:
1. Install Node.js (v14+ recommended).
2. Create a MySQL server and note host, user, password. (Local MySQL is fine.)
3. In the same folder, run:
   npm init -y
   npm install express mysql2 body-parser
4. Adjust the `DB_CONFIG` object below with your MySQL credentials.
5. Run the server:
   node 3d-car-game-with-login-and-mysql.js
6. Open http://localhost:3000 in your browser.

This file contains:
- Express server (serves HTML page and API endpoints)
- On startup it creates database `game_db` and table `scores` if they don't exist
- Client HTML/JS/CSS is embedded in a template string and served at '/'
*/

const express = require('express');
const mysql = require('mysql2/promise');
const bodyParser = require('body-parser');

// ----- ADJUST THESE SETTINGS -----
const SERVER_PORT = 3000;
const DB_CONFIG = {
  host: 'localhost', // change if your DB is remote
  user: 'root',      // your MySQL username
  password: '',      // your MySQL password
  // database will be created by the server if it doesn't exist
};
// ---------------------------------

let pool;

async function initDatabase() {
  // create a connection, then create db and table if necessary
  const conn = await mysql.createConnection({ host: DB_CONFIG.host, user: DB_CONFIG.user, password: DB_CONFIG.password });
  await conn.query(`CREATE DATABASE IF NOT EXISTS game_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci`);
  await conn.changeUser({ database: 'game_db' });

  // create table
  const createTableSql = `
    CREATE TABLE IF NOT EXISTS scores (
      id INT AUTO_INCREMENT PRIMARY KEY,
      player VARCHAR(100) NOT NULL,
      score INT NOT NULL DEFAULT 0,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    ) ENGINE=InnoDB;
  `;
  await conn.query(createTableSql);
  await conn.end();

  // create a pool for later queries
  pool = mysql.createPool({ host: DB_CONFIG.host, user: DB_CONFIG.user, password: DB_CONFIG.password, database: 'game_db', waitForConnections: true, connectionLimit: 10, queueLimit: 0 });
  console.log('Database initialized and pool created.');
}

async function saveScore(player, score) {
  if (!pool) throw new Error('DB pool not initialized');
  const trimmed = (player || 'Unknown').toString().trim().substring(0, 100);
  const numericScore = parseInt(score) || 0;
  const [result] = await pool.query('INSERT INTO scores (player, score) VALUES (?, ?)', [trimmed, numericScore]);
  return result.insertId;
}

async function getTopScores(limit = 10) {
  if (!pool) throw new Error('DB pool not initialized');
  const [rows] = await pool.query('SELECT id, player, score, created_at FROM scores ORDER BY score DESC, created_at ASC LIMIT ?', [Number(limit)]);
  return rows;
}

// --- Express app ---
const app = express();
app.use(bodyParser.json({ limit: '1mb' }));

// Serve game page
app.get('/', (req, res) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(HTML_TEMPLATE);
});

// API: Save score
app.post('/api/save-score', async (req, res) => {
  try {
    const { player, score } = req.body || {};
    if (!player || player.toString().trim().length === 0) {
      return res.status(400).json({ ok: false, error: 'Player name required' });
    }
    const id = await saveScore(player, score || 0);
    res.json({ ok: true, id });
  } catch (err) {
    console.error('Error saving score:', err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// API: Get top scores
app.get('/api/top-scores', async (req, res) => {
  try {
    const limit = parseInt(req.query.limit) || 10;
    const rows = await getTopScores(limit);
    res.json({ ok: true, scores: rows });
  } catch (err) {
    console.error('Error fetching scores:', err);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// Start server after DB init
initDatabase().then(() => {
  app.listen(SERVER_PORT, () => {
    console.log(`Server running at http://localhost:${SERVER_PORT}`);
  });
}).catch(err => {
  console.error('Failed to initialize DB:', err);
  process.exit(1);
});


// ------------------ EMBEDDED HTML (served at /) ------------------
// The game HTML is embedded below. It contains a simple player name/login UI,
// stores the player name in localStorage and posts the score to /api/save-score
// when the game ends. It also displays a top-scores overlay fetched from server.

const HTML_TEMPLATE = `<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Car Scene - Mobile Controls (With Login & MySQL)</title>
    <style>
        /* --- keep most of original styles, but add overlays for login & leaderboard */
        body { margin: 0; overflow: hidden; background-color: #a0d7e6; font-family: 'Press Start 2P', cursive, sans-serif; overscroll-behavior: none; touch-action: none; }
        canvas { display: block; }
        #loading-screen { position: absolute; width: 100%; height: 100%; background-color: #000; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 2em; z-index: 100; opacity: 1; transition: opacity 0.5s ease-out; gap: 15px; }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        #ui-container { position: absolute; top: 10px; left: 10px; color: white; text-shadow: 1px 1px 3px black; z-index: 50; font-size: 1.2em; pointer-events: none; }
        #score { margin-bottom: 5px; }
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 2.2em; font-weight: bold; text-align: center; text-shadow: 2px 2px 5px black; display: none; z-index: 101; pointer-events: auto; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        #restart-button { background-color: #21c60ffc; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 0.6em; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); transition: background-color 0.3s ease; }
        #restart-button:hover { background-color: #0056b3; }
        .control-button { position: absolute; bottom: 20px; width: 80px; height: 80px; background-color: rgba(255,255,255,0.3); border: 2px solid rgba(0,0,0,0.5); border-radius: 50%; z-index: 60; display: flex; justify-content: center; align-items: center; font-size: 2.5em; color: rgba(0,0,0,0.7); cursor: pointer; user-select: none; -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none; -webkit-tap-highlight-color: transparent; pointer-events: auto; }
        .control-button:active { background-color: rgba(255,255,255,0.5); }
        #left-button { left: 20px; }
        #right-button { right: 20px; }

        /* Login overlay */
        #login-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 200; }
        #login-card { background: linear-gradient(180deg,#1f1f1f,#2b2b2b); padding: 20px; border-radius: 12px; color: white; width: 90%; max-width: 420px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
        #login-card h2 { margin: 0 0 10px 0; font-size: 1em; text-align: center; }
        #player-name { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 10px; border-radius: 8px; border: none; }
        #login-buttons { display:flex; gap:8px; justify-content:center; }
        #save-name-btn, #play-guest-btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }

        /* Leaderboard */
        #leaderboard { position: absolute; right: 10px; top: 10px; background: rgba(0,0,0,0.5); padding: 10px; color: white; border-radius: 8px; z-index: 120; max-width: 260px; font-size: 0.8em; }
        #leaderboard h3 { margin:0 0 8px 0; font-size: 1em; }
        #leaderboard ol { margin:0; padding-left: 18px; }

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    </style>
</head>

<body>
    <div id="loading-screen">
        <div id="loading-text">Loading Game...</div>
        <div id="loading-progress">0%</div>
    </div>

    <div id="container"></div>

    <div id="ui-container">
        <div id="player-display">Player: <span id="player-name-display">Guest</span></div>
        <div id="score">Score: 0</div>
    </div>

    <div id="leaderboard">
        <h3>Top Scores</h3>
        <ol id="top-scores-list"><li>Loading...</li></ol>
    </div>

    <div id="game-over">
        GAME OVER!
        <div id="final-score">Score: 0</div>
        <button id="restart-button">Restart</button>
    </div>

    <div id="left-button" class="control-button">◀</div>
    <div id="right-button" class="control-button">▶</div>

    <!-- Login overlay -->
    <div id="login-overlay">
        <div id="login-card">
            <h2>Enter Player Name</h2>
            <input id="player-name" placeholder="Your name (max 30 chars)" maxlength="30" />
            <div id="login-buttons">
                <button id="save-name-btn">Save</button>
                <button id="play-guest-btn">Play as Guest</button>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.164.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.164.1/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        // --- Keep variables and logic from your provided game, but add hooks for login/score saving ---
        let scene, camera, renderer, carModel, enemyCar;
        let score = 0;
        let isGameOver = false;
        const driveSpeed = 0.5;
        const enemyCarSpeed = 0.6;
        const roadWidth = 10;
        // (many variables omitted here for brevity - the game logic below is kept but slightly trimmed)

        // UI references
        const loadingScreen = document.getElementById('loading-screen');
        const loadingProgress = document.getElementById('loading-progress');
        const scoreElement = document.getElementById('score');
        const playerNameDisplay = document.getElementById('player-name-display');
        const loginOverlay = document.getElementById('login-overlay');
        const playerNameInput = document.getElementById('player-name');
        const saveNameBtn = document.getElementById('save-name-btn');
        const playGuestBtn = document.getElementById('play-guest-btn');
        const gameOverElement = document.getElementById('game-over');
        const restartButton = document.getElementById('restart-button');
        const finalScore = document.getElementById('final-score');
        const topScoresList = document.getElementById('top-scores-list');

        const loadingManager = new THREE.LoadingManager();
        loadingManager.onLoad = () => {
            loadingScreen.classList.add('hidden');
            setTimeout(() => { if (loadingScreen) loadingScreen.style.display = 'none'; }, 600);
        };
        loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
            const progress = Math.round((itemsLoaded / itemsTotal) * 100);
            loadingProgress.textContent = `${progress}%`;
        };

        // Minimal init to let the page run - full game code would live here (from your original file)
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xa0d7e6);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, -7);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('container').appendChild(renderer.domElement);

            // simple ground and placeholder car if model fails - keep the rest of your original game content here
            const roadGeo = new THREE.PlaneGeometry(roadWidth, 200);
            const roadMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const road = new THREE.Mesh(roadGeo, roadMat);
            road.rotation.x = -Math.PI / 2;
            scene.add(road);

            // try loading the ferrari model like before; fallback to box if fails
            const loader = new GLTFLoader(loadingManager);
            const dracoLoader = new DRACOLoader(loadingManager);
            dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.7/');
            loader.setDRACOLoader(dracoLoader);
            loader.load('https://threejs.org/examples/models/gltf/ferrari.glb', (gltf) => {
                carModel = gltf.scene;
                carModel.scale.set(0.8,0.8,0.8);
                carModel.position.set(0,0.5,0);
                scene.add(carModel);
            }, undefined, (err) => {
                console.warn('Car model failed to load, using fallback box.', err);
                const fallback = new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
                fallback.position.set(0,0.5,0);
                carModel = fallback;
                scene.add(carModel);
            });

            // basic lights
            const amb = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xffffff, 1.2);
            dir.position.set(50,50,50);
            scene.add(dir);

            window.addEventListener('resize', onWindowResize, false);
            updateScoreDisplay();
        }

        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

        function updateScoreDisplay() { scoreElement.textContent = `Score: ${score}`; }

        function animate() {
            if (!renderer) return;
            requestAnimationFrame(animate);
            if (!isGameOver) {
                // your game logic should update score when player collects points
            }
            renderer.render(scene, camera);
        }

        // ---- Simple mock game loop to demonstrate saving score on game-over ----
        // (Replace this with your full game loop code; the important bits - user login & auto-save - are included here)
        function startMockPlay() {
            // increment score over time while not game over (demo behavior)
            const interval = setInterval(() => {
                if (isGameOver) { clearInterval(interval); return; }
                score += 1;
                updateScoreDisplay();
            }, 500);
        }

        function endGame() {
            isGameOver = true;
            gameOverElement.style.display = 'flex';
            finalScore.textContent = `Score: ${score}`;
            // Auto-save score for current player
            const player = localStorage.getItem('playerName') || 'Guest';
            saveScoreToServer(player, score).then(resp => {
                if (resp && resp.ok) {
                    console.log('Score saved, id=', resp.id);
                    fetchTopScores();
                } else {
                    console.warn('Could not save score to server');
                }
            }).catch(e => { console.error('Save failed', e); });
        }

        restartButton.addEventListener('click', () => {
            // reset state
            isGameOver = false;
            score = 0;
            updateScoreDisplay();
            gameOverElement.style.display = 'none';
            // restart gameplay (replace with your actual restart logic)
            startMockPlay();
        });

        // --- Login UI logic ---
        saveNameBtn.addEventListener('click', () => {
            const v = (playerNameInput.value || '').toString().trim().substring(0,30);
            if (v.length === 0) return alert('Please enter a name');
            localStorage.setItem('playerName', v);
            playerNameDisplay.textContent = v;
            loginOverlay.style.display = 'none';
            // start the game
            startMockPlay();
            animate();
            fetchTopScores();
        });
        playGuestBtn.addEventListener('click', () => {
            localStorage.setItem('playerName', 'Guest');
            playerNameDisplay.textContent = 'Guest';
            loginOverlay.style.display = 'none';
            startMockPlay();
            animate();
            fetchTopScores();
        });

        // If player already set, skip overlay
        window.addEventListener('load', () => {
            const existing = localStorage.getItem('playerName');
            if (existing) {
                playerNameDisplay.textContent = existing;
                loginOverlay.style.display = 'none';
                startMockPlay();
                animate();
                fetchTopScores();
            } else {
                playerNameInput.focus();
            }
        });

        // Save score to server endpoint
        async function saveScoreToServer(player, scoreVal) {
            try {
                const resp = await fetch('/api/save-score', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player: player, score: scoreVal })
                });
                return await resp.json();
            } catch (err) {
                console.error('Network error saving score', err);
                return null;
            }
        }

        async function fetchTopScores() {
            try {
                const resp = await fetch('/api/top-scores?limit=10');
                const json = await resp.json();
                if (json && json.ok) {
                    topScoresList.innerHTML = '';
                    if (json.scores.length === 0) topScoresList.innerHTML = '<li>No scores yet</li>';
                    json.scores.forEach(row => {
                        const li = document.createElement('li');
                        li.textContent = `${row.player} — ${row.score}`;
                        topScoresList.appendChild(li);
                    });
                }
            } catch (err) {
                console.error('Failed to fetch top scores', err);
            }
        }

        // Expose endGame to global for easy testing (in real game, call when collision occurs)
        window.endGame = endGame;

        // initialize the minimal scene
        init();
    </script>
</body>

</html>`;
